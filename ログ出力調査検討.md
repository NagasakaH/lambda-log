# AWS Lambda ログ出力調査検討レポート

## 概要

本レポートは、複数のLambda関数のログ出力を効率的かつコスト効果的に管理するためのベストプラクティスと推奨パターンをまとめたものです。  
対象環境: C# (.NET) Lambda関数、API Gateway経由およびStepFunctionsからの呼び出し

---

## 1. CloudWatch Logs の費用構造

### 1.1 費用の3つの柱

| 費用項目 | 説明 | US East (N. Virginia) 参考価格 |
|---------|------|------------------------------|
| **取り込み (Ingestion)** | ログデータをCloudWatch Logsに送信 | $0.50/GB (Standard), $0.25/GB (Infrequent Access) |
| **保存 (Storage)** | ログデータの保管 | $0.03/GB/月 |
| **分析 (Analysis)** | Logs Insightsでのクエリ | $0.0050/GB スキャン |

### 1.2 2025年5月発表: 段階的価格設定 (Tiered Pricing)

Lambda ログは **Vended Logs** として分類され、ボリュームベースの段階的価格が自動適用されます。

| データ量 | Standard クラス | Infrequent Access クラス |
|---------|----------------|------------------------|
| 最初の 10TB/月 | $0.50/GB | $0.25/GB |
| 次の 20TB/月 | $0.25/GB | $0.15/GB |
| 次の 20TB/月 | $0.10/GB | $0.075/GB |
| 50TB超/月 | $0.05/GB | $0.05/GB |

**重要**: 60TB/月のログを生成する場合、従来の$30,000から$12,500へ **58%のコスト削減** が実現されます。

---

## 2. ログ出力先の選択肢

### 2.1 比較表

| 出力先 | 初期費用 | 主なユースケース | リアルタイム分析 | 長期保存 |
|-------|---------|----------------|----------------|---------|
| **CloudWatch Logs (Standard)** | $0.50/GB〜 | 本番環境の監視、アラート | ✅ Live Tail, Insights | △ 高コスト |
| **CloudWatch Logs (Infrequent Access)** | $0.25/GB〜 | アーカイブ、フォレンジック分析 | △ 一部機能制限 | ○ |
| **Amazon S3** | $0.25/GB〜 | 長期保存、コンプライアンス | ✗ | ✅ 最安 |
| **Amazon Data Firehose** | $0.25/GB〜 | サードパーティツール連携 | ○ | ○ |

### 2.2 ログクラスの機能比較

| 機能 | Standard | Infrequent Access |
|-----|----------|-------------------|
| CloudWatch Logs Insights | ✅ 全コマンド | ✅ 大部分のコマンド |
| Metric Filter | ✅ | ✗ |
| Subscription Filter | ✅ | ✗ |
| Live Tail | ✅ | ✗ |
| 異常検知 (Anomaly Detection) | ✅ | ✗ |
| クロスアカウント機能 | ✅ | ✅ |

**注意**: ロググループのクラスは作成後に変更できません。

---

## 3. ロググループ設計のベストプラクティス

### 3.1 命名規則

デフォルト: `/aws/lambda/<function-name>`

**推奨カスタムパターン**:
```
/application/<environment>/<service-name>/lambda
例: /application/production/order-service/lambda
```

### 3.2 ロググループ統合 vs 分離

#### パターンA: 関数ごとに個別ロググループ (デフォルト)

```
/aws/lambda/order-create-function
/aws/lambda/order-update-function
/aws/lambda/order-delete-function
```

**メリット**:
- 関数単位での詳細な監視が可能
- 関数ごとの保持期間設定
- アクセス制御が容易

**デメリット**:
- ロググループ数が増大
- 横断的な分析が煩雑

#### パターンB: サービス単位で統合ロググループ

```
/application/production/order-service/lambda  ← 複数のLambdaが共有
```

**メリット**:
- 関連ログの一元管理
- Logs Insightsでの横断検索が容易
- 管理コストの削減

**デメリット**:
- 細かい保持期間設定ができない

### 3.3 推奨構成

| 環境 | ロググループクラス | 出力先 | 保持期間 |
|-----|------------------|-------|---------|
| 開発 (Dev) | Standard | CloudWatch Logs | 7日 |
| ステージング | Standard | CloudWatch Logs | 14日 |
| 本番 (重要ログ) | Standard | CloudWatch Logs | 30日 |
| 本番 (アーカイブ) | Infrequent Access または S3 | CloudWatch Logs / S3 | 90日〜1年 |

---

## 4. 費用最適化の推奨パターン

### 4.1 ログレベルによる出力制御

```
┌─────────────────────────────────────────────────────────────┐
│                    ログ出力戦略                              │
├─────────────────────────────────────────────────────────────┤
│  ERROR/WARN  →  CloudWatch Logs (Standard)                  │
│               - Metric Filter でアラート設定                  │
│               - 即時対応が必要なログ                          │
├─────────────────────────────────────────────────────────────┤
│  INFO        →  CloudWatch Logs (Infrequent Access)         │
│               または S3 直接出力                              │
│               - 監査・トラブルシューティング用                 │
├─────────────────────────────────────────────────────────────┤
│  DEBUG       →  開発環境のみ出力                             │
│               または サンプリング (10%程度)                   │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 推奨アーキテクチャ

```
Lambda関数
    │
    ├── ERROR/WARN ──────→ CloudWatch Logs (Standard)
    │                           │
    │                           ├── Metric Filter → CloudWatch Alarm → SNS通知
    │                           └── Live Tail (リアルタイム監視)
    │
    └── INFO ────────────→ CloudWatch Logs (Delivery クラス)
                                │
                                └── S3 (長期保存・Athenaで分析)
```

### 4.3 コスト比較シミュレーション

**前提条件**: 月間100GBのログ出力 (ERROR/WARN: 10GB, INFO: 90GB)

| パターン | 構成 | 月額費用概算 |
|---------|------|------------|
| **従来方式** | 全てCloudWatch Standard | $50 |
| **最適化A** | Standard + Infrequent Access | $32.50 |
| **最適化B** | Standard(10GB) + S3直接(90GB) | $27.50 |

---

## 5. C# (.NET) Lambda でのログ実装

### 5.1 Lambda Advanced Logging Controls

Lambda は .NET ランタイムで以下の制御をサポートします:

- **ログフォーマット**: JSON または Plain Text
- **ログレベル**: TRACE, DEBUG, INFO, WARN, ERROR, FATAL
- **カスタムロググループ**: 任意のロググループへ出力可能

### 5.2 ILambdaLogger を使用した構造化ログ

```csharp
public class Function
{
    public string FunctionHandler(APIGatewayProxyRequest request, ILambdaContext context)
    {
        // INFO レベルログ
        context.Logger.LogInformation("Processing request for user {userId}", request.PathParameters["userId"]);
        
        try
        {
            // 処理
        }
        catch (Exception ex)
        {
            // ERROR レベルログ (自動的にJSON形式で出力)
            context.Logger.LogError(ex, "Failed to process request");
            throw;
        }
        
        return "Success";
    }
}
```

**JSON出力例**:
```json
{
    "timestamp": "2026-01-26T23:19:40.789Z",
    "level": "Information",
    "requestId": "8f711428-7e55-46f9-ae88-2a65d4f85fc5",
    "traceId": "1-6408af34-50f56f5b5677a7d763973804",
    "message": "Processing request for user user-123",
    "userId": "user-123"
}
```

### 5.3 Powertools for AWS Lambda (.NET) の活用

**インストール**:
```bash
dotnet add package AWS.Lambda.Powertools.Logging
```

**実装例**:
```csharp
using AWS.Lambda.Powertools.Logging;

public class Function
{
    [Logging(LogEvent = true, Service = "order-service")]
    public async Task<APIGatewayProxyResponse> FunctionHandler(
        APIGatewayProxyRequest request, 
        ILambdaContext context)
    {
        Logger.LogInformation("Order processing started");
        
        // 追加キーの付与
        Logger.AppendKey("orderId", "ORD-12345");
        Logger.AppendKey("customerId", "CUST-67890");
        
        try
        {
            // ビジネスロジック
            return new APIGatewayProxyResponse { StatusCode = 200 };
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Order processing failed");
            throw;
        }
    }
}
```

**Powertools の主な機能**:
- 構造化JSONログ出力
- Lambda コンテキスト情報の自動キャプチャ
- 相関ID (Correlation ID) のサポート
- ログサンプリング機能
- Microsoft.Extensions.Logging (ILogger) インターフェース対応

### 5.4 環境変数設定

```yaml
# serverless.yml または SAM template
Environment:
  Variables:
    POWERTOOLS_SERVICE_NAME: order-service
    POWERTOOLS_LOG_LEVEL: Information  # 本番: Warning または Error
    POWERTOOLS_LOGGER_CASE: SnakeCase
```

---

## 6. 異常検知の実装

### 6.1 Metric Filter + CloudWatch Alarm

**Metric Filter 設定** (CloudFormation/SAM):
```yaml
ErrorMetricFilter:
  Type: AWS::Logs::MetricFilter
  Properties:
    LogGroupName: /aws/lambda/order-service
    FilterPattern: '{ $.level = "Error" }'
    MetricTransformations:
      - MetricName: ErrorCount
        MetricNamespace: OrderService
        MetricValue: "1"
        DefaultValue: 0

ErrorAlarm:
  Type: AWS::CloudWatch::Alarm
  Properties:
    AlarmName: OrderService-ErrorAlarm
    MetricName: ErrorCount
    Namespace: OrderService
    Statistic: Sum
    Period: 300
    EvaluationPeriods: 1
    Threshold: 3
    ComparisonOperator: GreaterThanOrEqualToThreshold
    AlarmActions:
      - !Ref AlertSNSTopic
```

### 6.2 CloudWatch Logs Anomaly Detection (Standard クラスのみ)

Standard ロググループでは、機械学習ベースの異常検知が利用可能です。
パターンの自動認識により、通常と異なるログパターンを検出できます。

---

## 7. まとめ: 推奨構成

### 7.1 小〜中規模システム (月間 < 50GB)

```
すべてのLambda → CloudWatch Logs (Standard)
                     │
                     ├── Metric Filter (ERROR/WARN)
                     │        └── CloudWatch Alarm → SNS
                     │
                     └── 保持期間: 30日
```

### 7.2 大規模システム (月間 > 50GB) または費用最適化重視

```
Lambda関数
    │
    ├── [LogLevel: ERROR/WARN]
    │        └── CloudWatch Logs (Standard) 
    │              ├── Metric Filter → Alarm
    │              └── 保持期間: 30日
    │
    └── [LogLevel: INFO]
             └── S3 直接出力 (Delivery クラス経由)
                   └── 必要時 Athena で分析
```

### 7.3 チェックリスト

- [ ] ログフォーマットをJSONに設定
- [ ] 環境ごとにログレベルを適切に設定 (本番: WARN以上)
- [ ] 保持期間を設定 (デフォルトは無期限で費用増大)
- [ ] ERROR/WARNにMetric FilterとAlarmを設定
- [ ] 大量ログはS3またはInfrequent Accessクラスを検討
- [ ] Powertools for AWS Lambda (.NET) の導入を検討

---

## 参考情報・URL

### 公式ドキュメント

| タイトル | URL |
|---------|-----|
| Working with Lambda function logs | https://docs.aws.amazon.com/lambda/latest/dg/monitoring-logs.html |
| Log and monitor C# Lambda functions | https://docs.aws.amazon.com/lambda/latest/dg/csharp-logging.html |
| CloudWatch Logs Log Classes | https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/CloudWatch_Logs_Log_Classes.html |
| Analyzing, optimizing, and reducing CloudWatch costs | https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/cloudwatch_billing.html |
| Sending Lambda function logs to Amazon S3 | https://docs.aws.amazon.com/lambda/latest/dg/logging-with-s3.html |
| Configuring CloudWatch log groups | https://docs.aws.amazon.com/lambda/latest/dg/monitoring-cloudwatchlogs-loggroups.html |
| Configuring JSON and plain text log formats | https://docs.aws.amazon.com/lambda/latest/dg/monitoring-cloudwatchlogs-logformat.html |

### Powertools for AWS Lambda (.NET)

| タイトル | URL |
|---------|-----|
| Logging V2 - Powertools for AWS Lambda (.NET) | https://docs.aws.amazon.com/powertools/dotnet/core/logging-v2/ |
| Introducing AWS Lambda Powertools for .NET | https://aws.amazon.com/blogs/compute/introducing-aws-lambda-powertools-for-net/ |
| JSON Structured Logging for .NET Lambda Functions | https://aws.amazon.com/blogs/developer/structured-logging-for-net-lambda/ |

### ブログ・発表記事

| タイトル | URL |
|---------|-----|
| AWS Lambda introduces tiered pricing for Amazon CloudWatch Logs (2025年5月) | https://aws.amazon.com/blogs/compute/aws-lambda-introduces-tiered-pricing-for-amazon-cloudwatch-logs-and-additional-logging-destinations/ |
| New CloudWatch Logs log class for infrequent access logs | https://aws.amazon.com/blogs/aws/new-amazon-cloudwatch-log-class-for-infrequent-access-logs-at-a-reduced-price/ |
| Introducing advanced logging controls for AWS Lambda functions | https://aws.amazon.com/blogs/compute/introducing-advanced-logging-controls-for-aws-lambda-functions/ |
| Simplifying Lambda function development using CloudWatch Logs Live Tail | https://aws.amazon.com/blogs/compute/simplifying-lambda-function-development-using-cloudwatch-logs-live-tail-and-metrics-insights/ |

### 料金情報

| タイトル | URL |
|---------|-----|
| Amazon CloudWatch Pricing | https://aws.amazon.com/cloudwatch/pricing/ |

---

**作成日**: 2026年1月27日  
**調査ツール**: aws-knowledge-mcp-server, aws-documentation-mcp-server
